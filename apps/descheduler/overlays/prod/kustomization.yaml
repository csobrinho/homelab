# From https://github.com/kubernetes-sigs/descheduler/blob/master/charts/descheduler/values.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

helmCharts:
  - name: descheduler
    repo: https://kubernetes-sigs.github.io/descheduler/
    releaseName: descheduler
    namespace: kube-system
    version: 0.33.0
    includeCRDs: true
    valuesInline:
      kind: Deployment
      replicas: 2
      deschedulerPolicy:
        profiles:
          - name: default
            pluginConfig:
              - name: DefaultEvictor
                args:
                  evictFailedBarePods: true
                  evictLocalStoragePods: true
                  evictSystemCriticalPods: true
              - name: RemoveDuplicates
              - name: RemovePodsHavingTooManyRestarts
                args:
                  podRestartThreshold: 100
                  includingInitContainers: true
              - name: RemovePodsViolatingNodeAffinity
                args:
                  nodeAffinityType:
                    - requiredDuringSchedulingIgnoredDuringExecution
              - name: RemovePodsViolatingNodeTaints
              - name: RemovePodsViolatingInterPodAntiAffinity
              - name: RemovePodsViolatingTopologySpreadConstraint
              - name: LowNodeUtilization
                args:
                  thresholds:
                    cpu: 20
                    memory: 20
                    pods: 20
                  targetThresholds:
                    cpu: 50
                    memory: 50
                    pods: 50
              - name: RemoveFailedPods
                args:
                  reasons:
                    - ContainerStatusUnknown
                    - NodeAffinity
                    - NodeShutdown
                    - Terminated
                    - UnexpectedAdmissionError
                  includingInitContainers: true
                  excludeOwnerKinds:
                    - Job
                  minPodLifetimeSeconds: 1800
            plugins:
              balance:
                enabled:
                  - RemoveDuplicates
                  - RemovePodsViolatingTopologySpreadConstraint
                  - LowNodeUtilization
              deschedule:
                enabled:
                  - RemovePodsHavingTooManyRestarts
                  - RemovePodsViolatingNodeTaints
                  - RemovePodsViolatingNodeAffinity
                  - RemovePodsViolatingInterPodAntiAffinity
                  - RemoveFailedPods
      service:
        enabled: true
      serviceMonitor:
        enabled: true
      leaderElection:
        enabled: true
