# From https://github.com/truecharts/charts/blob/master/charts/stable/home-assistant/values.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base
  - ingress-route.yaml

helmCharts:
  - name: home-assistant
    repo: http://pajikos.github.io/home-assistant-helm-chart/
    releaseName: home-assistant
    namespace: home-assistant
    version: 0.2.75
    includeCRDs: true
    valuesInline:
      env:
        - name: TZ
          value: America/Los_Angeles
      service:
        type: NodePort
        port: 8123
      hostPort:
        enabled: true
        port: 8123
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      nodeSelector:
        kubernetes.io/hostname: "infra1" # Pin to infra1 because it needs the SonOff hardware.
      securityContext:
        privileged: true
      persistence:
        enabled: true
        retain: true
        accessMode: ReadWriteOnce
        size: 5Gi
        storageClass: "longhorn-retain"
      additionalVolumes:
        - hostPath:
            path: /dev/serial/by-id/usb-ITEAD_SONOFF_Zigbee_3.0_USB_Dongle_Plus_V2_20230831101002-if00
            type: CharDevice
          name: sonoff-usb
        - hostPath:
            path: /run/dbus
            type: Directory
          name: dbus
      additionalMounts:
        - mountPath: /dev/serial/by-id/usb-ITEAD_SONOFF_Zigbee_3.0_USB_Dongle_Plus_V2_20230831101002-if00
          name: sonoff-usb
        - mountPath: /run/dbus
          name: dbus
      addons:
        codeserver:
          enabled: true

patches:
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: home-assistant
      spec:
        volumeClaimTemplates:
          - apiVersion: v1
            kind: PersistentVolumeClaim
            metadata:
              name: home-assistant
            spec:
              accessModes:
              - ReadWriteOnce
              resources:
                requests:
                  storage: 5Gi
              storageClassName: longhorn-retain
