# From https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-prometheus-stack/values.yaml
nameOverride: prometheus

defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: true
    configReloaders: true
    general: true
    k8s: true
    kubeApiserverAvailability: true
    kubeApiserverBurnrate: true
    kubeApiserverHistogram: true
    kubeApiserverSlos: true
    kubelet: true
    kubePrometheusGeneral: true
    kubePrometheusNodeRecording: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    kubeStateMetrics: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true
    # Disabled.
    kubeControllerManager: false
    kubeProxy: false
    kubeSchedulerAlerting: false
    kubeSchedulerRecording: false

prometheus:
  prometheusSpec:
    externalUrl: https://prometheus.sobrinho.pt
    replicas: 1
    ruleSelectorNilUsesHelmValues: false
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    probeSelectorNilUsesHelmValues: false
    retention: 2d
    enableAdminAPI: true
    walCompression: true
    additionalArgs:
      - name: storage.tsdb.no-lockfile # To avoid issues when the container is forced killed.
    maximumStartupDurationSeconds: 2400 # 40 minutes to allow for WAL replay on large datasets.
    resources:
      limits:
        cpu: 2500m
        memory: 3.5Gi
      requests:
        cpu: 500m
        memory: 512Mi
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: ceph-block
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 32Gi

containers:
  - name: prometheus
    startupProbe:
      failureThreshold: 1000 # To allow for WAL replay on large datasets.

alertmanager:
  alertmanagerSpec:
    externalUrl: https://alertmanager.sobrinho.pt
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: ceph-block
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 5Gi
  config:
    route:
      group_by: ["alertname", "severity"]
      group_wait: 10s
      group_interval: 5m
      repeat_interval: 4h
      receiver: "general"
      routes:
        # Critical alerts - immediate notification.
        - match:
            severity: critical
          receiver: "critical"
          group_wait: 10s
          repeat_interval: 30m
        # Warning alerts - less frequent.
        - match:
            severity: warning
          receiver: "warning"
          group_wait: 5m
          repeat_interval: 12h
    receivers:
      - name: "critical"
        webhook_configs:
          - url: "https://node-red.sobrinho.pt/webhooks/1ebf4e6a-38bb-4fbd-9cf5-27420b8f0579/critical"
            send_resolved: true
            http_config:
              follow_redirects: true
      - name: "warning"
        webhook_configs:
          - url: "https://node-red.sobrinho.pt/webhooks/1ebf4e6a-38bb-4fbd-9cf5-27420b8f0579/warning"
            send_resolved: true
            http_config:
              follow_redirects: true
      - name: "general"
        webhook_configs:
          - url: "https://node-red.sobrinho.pt/webhooks/1ebf4e6a-38bb-4fbd-9cf5-27420b8f0579/general"
            send_resolved: true
            http_config:
              follow_redirects: true
    inhibit_rules:
      # Existing rules from https://github.com/prometheus-community/helm-charts/blob/e383011a042d4abf70b0163a1fa95589d57f1298/charts/kube-prometheus-stack/values.yaml#L512-L533
      - source_matchers:
          - "severity = critical"
        target_matchers:
          - "severity =~ warning|info"
        equal:
          - "namespace"
          - "alertname"
      - source_matchers:
          - "severity = warning"
        target_matchers:
          - "severity = info"
        equal:
          - "namespace"
          - "alertname"
      - source_matchers:
          - "alertname = InfoInhibitor"
        target_matchers:
          - "severity = info"
        equal:
          - "namespace"
      - target_matchers:
          - "alertname = InfoInhibitor"

      # Added rules.
      # Suppress detailed alerts when top-level cluster health fails.
      - source_matchers:
          - "alertname = CephHealthError"
          - "severity = critical"
        target_matchers:
          - "alertname =~ ^Ceph(OSD|PG|Mon|Pool).*"

grafana:
  defaultDashboardsTimezone: America/Los_Angeles

kube-state-metrics:
  selfMonitor:
    enabled: true

cleanPrometheusOperatorObjectNames: true

prometheusOperator:
  # Disable linkerd injection for admission webhooks jobs
  admissionWebhooks:
    patch:
      podAnnotations:
        linkerd.io/inject: disabled

# Enable serviceaccount automount
prometheus-node-exporter:
  serviceAccount:
    automountServiceAccountToken: true
  tolerations:
    - key: node.kubernetes.io/unreachable
      effect: NoExecute
      operator: Exists
      tolerationSeconds: 60

kubeControllerManager:
  enabled: false

kubeScheduler:
  enabled: false

kubeProxy:
  enabled: false
