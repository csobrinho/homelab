name: Validate Kustomize + Helm

on:
  pull_request:
    branches:
      - main
      - master
    paths:
      - '**.yaml'
      - '**.yml'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.7.1"
      
      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.19.0'
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
      
      - name: Find and validate changed Kustomize directories
        run: |
          set -e
          
          # Get changed files
          changed_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          echo "Changed files:"
          echo "$changed_files"
          echo ""
          
          # Find unique Kustomize directories
          declare -A seen_dirs
          
          for file in $changed_files; do
            dir=$(dirname "$file")
            
            while [ "$dir" != "." ]; do
              if [ -f "$dir/kustomization.yaml" ] || [ -f "$dir/kustomization.yml" ]; then
                if [ -z "${seen_dirs[$dir]}" ]; then
                  seen_dirs[$dir]=1
                  
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "ðŸ” Validating: $dir"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  
                  # Build with Kustomize (helm repos auto-added)
                  output_file="/tmp/$(echo $dir | tr '/' '_')-output.yaml"
                  kustomize build --enable-helm "$dir" > "$output_file"
                  echo "âœ… Kustomize build successful"
                  
                  # Validate with kubectl
                  kubectl apply --dry-run=client -f "$output_file"
                  echo "âœ… kubectl dry-run successful"
                  echo ""
                fi
                break
              fi
              dir=$(dirname "$dir")
            done
          done
          
          echo "âœ… All validations completed!"
