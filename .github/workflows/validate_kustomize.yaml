name: Validate Kustomize + Helm

on:
  pull_request:
    branches:
      - main
      - master
    paths:
      - '**.yaml'
      - '**.yml'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.7.1"
      
      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.19.0'
      
      - name: Install kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/
      
      - name: Find and validate changed Kustomize directories
        run: |
          set -e
          
          # Get changed files
          changed_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          echo "Changed files:"
          echo "$changed_files"
          echo ""
          
          # Track if we found any directories
          found_dirs=false
          
          # Find unique Kustomize directories
          declare -A seen_dirs
          
          for file in $changed_files; do
            dir=$(dirname "$file")
            
            while [ "$dir" != "." ]; do
              if [ -f "$dir/kustomization.yaml" ] || [ -f "$dir/kustomization.yml" ]; then
                if [ -z "${seen_dirs[$dir]}" ]; then
                  seen_dirs[$dir]=1
                  found_dirs=true
                  
                  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                  echo "üîç Validating: $dir"
                  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                  
                  # Build with Kustomize
                  output_file="/tmp/$(echo $dir | tr '/' '_')-output.yaml"
                  if ! kustomize build --enable-helm "$dir" > "$output_file"; then
                    echo "‚ùå Kustomize build FAILED for $dir"
                    exit 1
                  fi
                  echo "‚úÖ Kustomize build successful"
                  
                  # Validate with kubeconform
                  if ! kubeconform -summary -output pretty "$output_file"; then
                    echo "‚ùå Kubernetes resource validation FAILED for $dir"
                    exit 1
                  fi
                  echo "‚úÖ Kubernetes validation successful"
                  
                  # Show stats
                  echo "üìä Stats:"
                  echo "   Lines: $(wc -l < $output_file)"
                  echo "   Resources: $(grep -c '^kind:' $output_file || echo 0)"
                  echo ""
                fi
                break
              fi
              dir=$(dirname "$dir")
            done
          done
          
          if [ "$found_dirs" = false ]; then
            echo "‚ÑπÔ∏è  No Kustomize directories were modified in this PR"
          else
            echo "‚úÖ All validations completed successfully!"
          fi                fi
                break
              fi
              dir=$(dirname "$dir")
            done
          done
          
          echo "‚úÖ All validations completed!"
